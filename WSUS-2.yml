---
- hosts: all
  gather_facts: false
  vars:
    WSUS_Server: http://IFWQTV0100.TEST01GLOBAL.LLOYDSTSB.COM:8530
  tasks:

  - name: Delete the AU\UseWUServer registry key
    win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
      name: UseWUServer
      state: absent
      delete_key: yes

  - name: Amend/Add new key to the registry
    win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: WUServer
      data: "{{ WSUS_Server }}"
      type: string

  - name: Amend/Add new key to the registry
    win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: WUStatusServer
      data: "{{ WSUS_Server }}"
      type: string

  - name: Amend/Add new key to the registry
    win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: TargetGroupEnabled
      data: "1"
      type: dword

  - name: Obtain Information about the Operating System
    win_reg_stat:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion
      name: ProductName
    register: os

  - name: Amend/Add new key to the registry
    win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: TargetGroup
      data: "Server_2016"
      type: string

  - name: restart the windows update service
    win_service:
#      name: wuauserv
      name: spooler
      state: restarted
    register: result

  - name: debug1
    ansible.builtin.debug:
      msg: "Windows Update service has been restarted"
    when: result.changed == true
